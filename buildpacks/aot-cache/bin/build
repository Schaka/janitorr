#!/usr/bin/bash
set -euo pipefail

LAYER_DIR="/workspace/aot-cache"

cd /workspace
mkdir -p "${LAYER_DIR}"
echo "Creating AOT cache at $LAYER_DIR"

# Java 25, single step instead of split in 2
java -cp "." -XX:+UnlockExperimentalVMOptions -XX:+UseCompactObjectHeaders -Xlog:cds=info -Xlog:aot=info -Xlog:class+path=info \
     -XX:AOTCacheOutput=$LAYER_DIR/janitorr.aot \
     -Dspring.aot.enabled=true -Dspring.profiles.active=leyden -Dspring.context.exit=onRefresh org.springframework.boot.loader.launch.JarLauncher

# Layer metadata (launch = available at runtime)
cat > "${LAYER_DIR}.toml" <<EOL
[types]
launch = true
build = false
cache = false
EOL

echo "Done creating AOT cache."