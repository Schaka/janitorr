#!/usr/bin/bash
set -euo pipefail

if [[ -z "${BP_NATIVE_IMAGE:-}" || "${BP_NATIVE_IMAGE}" == "true" ]]; then
    echo "BP_NATIVE_IMAGE not explicitly set to false, not contributing AOTCache"
    exit 0
fi

LAYER_DIR="/workspace/aot-cache"
export LC_ALL=en_US.UTF-8

cd /workspace
mkdir -p "${LAYER_DIR}"
echo "Creating AOT cache at $LAYER_DIR"

# Java 24 - does NOT work on Java 25 anymore
#java -cp "/workspace" \
#     -Xlog:cds=info -Dspring.aot.enabled=true -Dspring.profiles.active=leyden \
#     -XX:AOTMode=record -XX:AOTConfiguration=$LAYER_DIR/janitorr.aotconf \
#     -Dspring.context.exit=onRefresh org.springframework.boot.loader.launch.JarLauncher
#
#java -cp "." \
#     -Xlog:cds=info -Xlog:class+path=info -Dspring.aot.enabled=true -Dspring.profiles.active=leyden \
#     -XX:AOTMode=create -XX:AOTConfiguration=$LAYER_DIR/janitorr.aotconf -XX:AOTCache=$LAYER_DIR/janitorr.aot \
#     org.springframework.boot.loader.launch.JarLauncher

# Java 25, single step instead of split in 2
java -cp "." -XX:+UnlockExperimentalVMOptions -XX:+UseCompactObjectHeaders -Xlog:cds=info -Xlog:aot=info -Xlog:class+path=info \
     -XX:AOTCacheOutput=$LAYER_DIR/janitorr.aot \
     -Dspring.aot.enabled=true -Dspring.profiles.active=leyden -Dspring.context.exit=onRefresh org.springframework.boot.loader.launch.JarLauncher

# Layer metadata (launch = available at runtime)
cat > "${LAYER_DIR}.toml" <<EOL
[types]
launch = true
build = false
cache = false
EOL

echo "Done creating AOT cache."